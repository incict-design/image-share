<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>画像共有アプリ（ポップアップ拡大付き）</title>
<style>
body{
  font-family:system-ui,-apple-system,"メイリオ",sans-serif;
  padding:20px;
  max-width:900px;
  margin:0 auto;
}
header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:16px;
}
.uploader{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
#gallery{
  display:grid;
  gap:12px;
  grid-template-columns: repeat(4, 1fr); /* 最小4列 */
  margin-top:20px;
}
.card{
  border:1px solid #ddd;
  border-radius:8px;
  padding:8px;
  background:white;
  cursor:pointer;
}
.card img{
  width:100%;
  height:160px; /* 小さくしました */
  object-fit:cover;
  border-radius:6px;
  transition: transform 0.3s;
}
.card img:hover{
  transform: scale(1.05);
}
.meta{
  font-size:12px;
  color:#555;
  margin-top:6px;
  white-space:pre-line;
}
#status{
  font-size:13px;
  color:#333;
}
button{
  cursor:pointer;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #bbb;
  background:#f7f7f7;
}

/* レスポンシブ: 幅が広くなるほど列数増加 */
@media(min-width: 1100px){ #gallery{ grid-template-columns: repeat(6,1fr); } }
@media(min-width: 900px) and (max-width:1099px){ #gallery{ grid-template-columns: repeat(5,1fr); } }
@media(max-width: 899px) and (min-width:700px){ #gallery{ grid-template-columns: repeat(4,1fr); } }
@media(max-width: 699px) and (min-width:500px){ #gallery{ grid-template-columns: repeat(3,1fr); } }
@media(max-width: 499px) and (min-width:350px){ #gallery{ grid-template-columns: repeat(2,1fr); } }
@media(max-width: 349px){ #gallery{ grid-template-columns: repeat(1,1fr); } }

/* 拡大表示用オーバーレイ */
#overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#overlay img{
  max-width:90%;
  max-height:90%;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>
<body>

<header>
  <h1>Image-Share</h1>
  <div id="status" style="margin-left:auto"></div>
</header>

<section class="uploader">
  <label>投稿者名（必須）<br>
    <input id="username" type="text" placeholder="">
  </label>
  <label>画像を選択<br>
    <input id="fileInput" type="file" accept="image/*">
  </label>
  <button id="uploadBtn">アップロード</button>
</section>

<section>
  <h2>共有ギャラリー</h2>
  <div id="gallery"></div>
</section>

<div id="overlay">
  <img id="overlayImg" src="">
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCzDqI2YaOLoU4muurvvxBs4fOOSkH8Yew",
  authDomain: "image-share-89916.firebaseapp.com",
  projectId: "image-share-89916",
  storageBucket: "image-share-89916.firebasestorage.app",
  messagingSenderId: "859639070035",
  appId: "1:859639070035:web:aab7543659c3d1a877f5a6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const usernameInput = document.getElementById("username");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const gallery = document.getElementById("gallery");
const status = document.getElementById("status");

const overlay = document.getElementById("overlay");
const overlayImg = document.getElementById("overlayImg");

uploadBtn.addEventListener("click", async () => {
  const name = usernameInput.value.trim();
  const file = fileInput.files[0];

  if(!name){ status.textContent="投稿者名を入力してください。"; return; }
  if(!file){ status.textContent="画像を選択してください。"; return; }

  uploadBtn.disabled = true;
  status.textContent = "アップロード中...";

  try {
    const ref = storage.ref("test-images/" + name + ".jpg");
    await ref.put(file);
    const url = await ref.getDownloadURL();
    await db.collection("test-images").doc(name).set({ username:name, url:url, updatedAt:new Date() });
    status.textContent = "アップロード完了！";
    fileInput.value = "";
  } catch(e) {
    console.error(e);
    status.textContent = "アップロード失敗。";
  } finally { uploadBtn.disabled = false; }
});

// ギャラリー更新（リアルタイム）
db.collection("test-images").onSnapshot(snapshot => {
  gallery.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.className = "card";
    const imgEl = document.createElement("img");
    imgEl.src = data.url;
    div.appendChild(imgEl);
    const metaDiv = document.createElement("div");
    metaDiv.className = "meta";
    metaDiv.textContent = `${data.username}\n${new Date(data.updatedAt.seconds*1000).toLocaleString()}`;
    div.appendChild(metaDiv);

    imgEl.addEventListener("click", ()=>{
      overlayImg.src = data.url;
      overlay.style.display = "flex";
    });

    gallery.appendChild(div);
  });
});

overlay.addEventListener("click", ()=>{
  overlay.style.display = "none";
  overlayImg.src = "";
});
</script>
</body>
</html>
