<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>登録制 画像共有アプリ</title>
<style>
body{ font-family:system-ui,-apple-system,"メイリオ",sans-serif; padding:20px; max-width:900px; margin:0 auto;}
header{ display:flex; align-items:center; gap:12px; margin-bottom:8px;}
#gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-auto-rows: 200px;
  gap: 10px;
  justify-items: center;
  margin-top: 10px;
}
/* スマホ画面用：横幅480px以下は2列 */
@media (max-width: 480px) {
  #gallery {
    grid-template-columns: repeat(2, 1fr);
  }
}
.card {
  width: 110px;
  height: 150px;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 4px;
  background: white;
  cursor: pointer;
  display:flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}
.card img {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 6px;
  transition: transform 0.3s;
}
.card img:hover{ transform: scale(1.05);}
.meta{ font-size:12px; color:#555; margin-top:4px; text-align:center; white-space:pre-line;}
.delete-btn{ position:absolute; top:6px; right:6px; background:red; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:12px; cursor:pointer;}
#status{ font-size:13px; color:#333;}
button{ cursor:pointer; padding:4px 10px; border-radius:6px; border:1px solid #bbb; background:#f7f7f7;}
#overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:1000;}
#overlay img{ max-width:90%; max-height:90%; border-radius:8px; cursor:pointer;}
.auth input{ margin-bottom:4px; display:block; padding:4px 6px;}
.auth-row{ display:flex; gap:10px; align-items:flex-end; margin-bottom:4px; }
.auth-row label{ font-size:12px; }
.auth-row input{ flex:1; }
.upload-row{ display:flex; gap:6px; align-items:center; margin-top:4px; }
.upload-row input, .upload-row button{ height:28px; } /* 高さ揃える */
</style>
</head>
<body>

<header>
  <h1>Image-Share</h1>
  <div id="status" style="margin-left:auto"></div>
</header>

<!-- 共有ギャラリー -->
<section>
  <div id="gallery"></div>
  <!-- ギャラリー下にファイル選択・アップロードボタン -->
  <div class="upload-row">
    <input id="fileInput" type="file" accept="image/*">
    <button id="uploadBtn">アップロード</button>
  </div>
</section>

<!-- アカウント -->
<section class="auth">
  <h3>アカウント</h3>
  <div id="authStatus"></div>

  <div class="auth-row">
    <input id="email" type="email" placeholder="メールアドレス">
    <input id="password" type="password" placeholder="パスワード：6桁以上">
  </div>

  <div class="auth-row">
    <button id="registerBtn">新規登録</button>
    <button id="loginBtn">ログイン</button>
    <button id="logoutBtn" style="display:none;">ログアウト</button>
  </div>

  <label>投稿者名（表示用 / 新規登録時のみ入力）<br>
    <input id="displayName" type="text" placeholder="新規登録時のみ入力">
  </label>
</section>

<div id="overlay">
  <img id="overlayImg" src="">
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyDYMt_zTbQZ5TffPH88wWnpYNTfTzklqGs",
  authDomain: "image-fda5a.firebaseapp.com",
  projectId: "image-fda5a",
  storageBucket: "image-fda5a.appspot.com",
  messagingSenderId: "755012980730",
  appId: "1:755012980730:web:39f15384f84588feba5e43"
};


firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// DOM
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const displayNameInput = document.getElementById("displayName");
const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const gallery = document.getElementById("gallery");
const status = document.getElementById("status");
const overlay = document.getElementById("overlay");
const overlayImg = document.getElementById("overlayImg");

// ----- 認証 -----
registerBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  const displayName = displayNameInput.value.trim();
  if(!email || !pass || !displayName){ alert("全て入力してください"); return; }
  try{
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    await userCredential.user.updateProfile({displayName:displayName});
    await userCredential.user.sendEmailVerification();
    alert("確認メールを送信しました。迷惑メールフォルダも確認してください。");
  }catch(e){ console.error(e); alert(e.message); }
});

loginBtn.addEventListener("click", async ()=>{
  const email=emailInput.value.trim();
  const pass=passwordInput.value;
  if(!email||!pass){ alert("メール・パスワードを入力してください"); return; }
  try{
    const userCredential = await auth.signInWithEmailAndPassword(email, pass);
    if(!userCredential.user.emailVerified){
      alert("メール認証が完了していません。確認メールをチェックしてください。");
      await auth.signOut();
      return;
    }
    authStatus.textContent = `ログイン: ${userCredential.user.displayName}`;
    logoutBtn.style.display="inline-block";
    registerBtn.style.display=loginBtn.style.display="none";
  }catch(e){ console.error(e); alert(e.message); }
});

logoutBtn.addEventListener("click", async ()=>{
  await auth.signOut();
  authStatus.textContent="未ログイン";
  logoutBtn.style.display="none";
  registerBtn.style.display=loginBtn.style.display="inline-block";
});

// ----- 投稿 -----
uploadBtn.addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user || !user.emailVerified){
    status.textContent = "ログインしてメール認証を完了してください";
    return;
  }
  const file = fileInput.files[0];
  if(!file){ status.textContent="画像を選択してください"; return; }

  uploadBtn.disabled=true;
  status.textContent="アップロード中...";
  try{
    const ref = storage.ref("test-images/"+user.uid);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    await db.collection("test-images").doc(user.uid).set({
      username:user.displayName,
      url:url,
      updatedAt:new Date()
    });
    status.textContent="アップロード完了！";
    fileInput.value="";
  }catch(e){ console.error(e); status.textContent="アップロード失敗"; }
  finally{ uploadBtn.disabled=false; }
});

// ----- ギャラリー -----
db.collection("test-images").onSnapshot(snapshot=>{
  gallery.innerHTML="";
  snapshot.forEach(doc=>{
    const data = doc.data();
    const docId = doc.id;

    const div = document.createElement("div");
    div.className="card";
    div.id=docId;

    const imgEl = document.createElement("img");
    imgEl.src=data.url;
    div.appendChild(imgEl);

    const metaDiv = document.createElement("div");
    metaDiv.className="meta";
    metaDiv.textContent=`${data.username}\n${new Date(data.updatedAt.seconds*1000).toLocaleString()}`;
    div.appendChild(metaDiv);

    // Fire Storageに存在しない場合のみ削除ボタン
    storage.ref("test-images/"+docId).getMetadata()
      .catch(()=>{
        const delBtn = document.createElement("button");
        delBtn.className="delete-btn";
        delBtn.textContent="削除";
        delBtn.addEventListener("click", async e=>{
          e.stopPropagation();
          if(!confirm("Firestoreからも削除しますか？")) return;
          try{ await db.collection("test-images").doc(docId).delete(); status.textContent="削除しました"; }
          catch(err){ console.error(err); status.textContent="削除失敗"; }
        });
        div.appendChild(delBtn);
      });

    imgEl.addEventListener("click", ()=>{ overlayImg.src=data.url; overlay.style.display="flex"; });

    gallery.appendChild(div);
  });
});

overlay.addEventListener("click", ()=>{ overlay.style.display="none"; overlayImg.src=""; });
</script>
</body>
</html>
